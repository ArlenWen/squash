# Squash - Docker é•œåƒå±‚å‹ç¼©å·¥å…·

**ä¸­æ–‡** | [English](README.md)

ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„é«˜æ€§èƒ½ Docker é•œåƒå±‚å‹ç¼©å‘½ä»¤è¡Œå·¥å…·ã€‚

## ğŸš€ ç‰¹æ€§

- **ğŸ”„ å¤šç§è¾“å…¥æº**: æ”¯æŒ Docker é•œåƒåç§°:æ ‡ç­¾æˆ–å¯¼å‡º/ä¿å­˜çš„é•œåƒæ–‡ä»¶
- **ğŸ“¤ çµæ´»è¾“å‡º**: ä¿å­˜åˆ°æ–‡ä»¶æˆ–ç›´æ¥åŠ è½½åˆ° Docker å¹¶æŒ‡å®šé•œåƒåç§°å’Œæ ‡ç­¾
- **ğŸ¯ æ™ºèƒ½å±‚åˆå¹¶**: 
  - æŒ‰æ•°é‡: å°†æœ€æ–°çš„ n å±‚åˆå¹¶ä¸ºä¸€å±‚
  - æŒ‰å±‚ ID: ä»æŒ‡å®šå±‚ ID åˆ°æœ€æ–°å±‚è¿›è¡Œåˆå¹¶
- **ğŸ“ ä¸´æ—¶ç›®å½•æ”¯æŒ**: é…ç½®ä¸­é—´æ–‡ä»¶çš„å­˜å‚¨ä½ç½®
- **ğŸ“ è¯¦ç»†è¾“å‡º**: æ“ä½œçš„è¯¦ç»†æ—¥å¿—è®°å½•
- **âš¡ å†…å­˜é«˜æ•ˆ**: å¤§æ–‡ä»¶æµå¼å¤„ç†é˜²æ­¢å†…å­˜æº¢å‡º
- **ğŸ”’ å®‰å…¨æ“ä½œ**: è·¯å¾„éå†ä¿æŠ¤å’Œé€‚å½“çš„é”™è¯¯å¤„ç†
- **ğŸ§ª å……åˆ†æµ‹è¯•**: å…¨é¢çš„å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•

## ğŸ“¦ å®‰è£…

### å‰ç½®è¦æ±‚
- Rust 1.70+ (ä»æºç æ„å»º)
- Docker (ç”¨äºå¤„ç† Docker é•œåƒ)

### ä»æºç æ„å»º
```bash
git clone https://github.com/your-username/squash.git
cd squash
cargo build --release
```

äºŒè¿›åˆ¶æ–‡ä»¶å°†ä½äº `target/release/squash`ã€‚

### é€šè¿‡ Cargo å®‰è£…
```bash
cargo install --path .
```

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# å‹ç¼©é•œåƒçš„æœ€æ–° 3 å±‚å¹¶ä¿å­˜åˆ°æ–‡ä»¶
squash squash --source nginx:latest --output nginx-squashed.tar --layers 3

# å‹ç¼©å±‚å¹¶ç›´æ¥åŠ è½½åˆ° Docker
squash squash --source nginx:latest --load my-nginx:squashed --layers 2

# ä½¿ç”¨ä¿å­˜çš„é•œåƒæ–‡ä»¶ä½œä¸ºæº
squash squash --source /path/to/image.tar --output squashed.tar --layers 3

# è¯¦ç»†è¾“å‡ºå’Œè‡ªå®šä¹‰ä¸´æ—¶ç›®å½•
squash squash --source nginx:latest --output nginx-squashed.tar --layers 3 --temp-dir /tmp/squash --verbose
```

### ğŸ“‹ å‘½ä»¤è¡Œé€‰é¡¹

| é€‰é¡¹ | ç®€å†™ | æè¿° |
|------|------|------|
| `--source` | `-s` | æºé•œåƒ (åç§°:æ ‡ç­¾æˆ–æ–‡ä»¶è·¯å¾„) |
| `--output` | `-o` | è¾“å‡ºæ–‡ä»¶è·¯å¾„ (å¦‚æœä¸ä½¿ç”¨ --load åˆ™å¿…éœ€) |
| `--load` | | å°†ç»“æœåŠ è½½åˆ° Docker å¹¶æŒ‡å®šåç§°:æ ‡ç­¾ |
| `--temp-dir` | `-t` | ä¸­é—´æ–‡ä»¶çš„ä¸´æ—¶ç›®å½• |
| `--layers` | `-l` | å±‚è§„èŒƒ (æ•°é‡æˆ–å±‚ ID) |
| `--verbose` | `-v` | å¯ç”¨è¯¦ç»†è¾“å‡º |

### ğŸ¯ å±‚è§„èŒƒç¤ºä¾‹

```bash
# åˆå¹¶æœ€æ–°çš„ 3 å±‚
--layers 3

# ä»ç‰¹å®šå±‚ ID åˆ°æœ€æ–°å±‚åˆå¹¶ (æœ€å°‘éœ€è¦ 8 ä¸ªå­—ç¬¦)
--layers "sha256:abc123def456"

# ä½¿ç”¨éƒ¨åˆ†æ‘˜è¦åˆå¹¶å±‚ (8+ ä¸ªå­—ç¬¦)
--layers "abc12345"
```

### ğŸ’¡ é«˜çº§ç¤ºä¾‹

```bash
# é¦–å…ˆå¯¼å‡º Docker é•œåƒï¼Œç„¶åå‹ç¼©
docker save nginx:latest -o nginx.tar
squash squash --source nginx.tar --output nginx-squashed.tar --layers 2

# å‹ç¼©å¹¶ç«‹å³åŠ è½½æ–°æ ‡ç­¾
squash squash --source nginx:latest --load nginx:optimized --layers 3 --verbose

# ä¸ºå¤§é•œåƒä½¿ç”¨è‡ªå®šä¹‰ä¸´æ—¶ç›®å½•
squash squash --source large-image:latest --output optimized.tar --layers 5 --temp-dir /tmp/squash-work
```


## âœ… æ ¸å¿ƒåŠŸèƒ½
- **ğŸ”§ CLI ç•Œé¢**: åŠŸèƒ½å®Œæ•´çš„å‘½ä»¤è¡Œç•Œé¢
- **ğŸ“¦ Docker é›†æˆ**: åŸç”Ÿ Docker é•œåƒå¯¼å‡º/å¯¼å…¥æ”¯æŒ
- **ğŸ” é•œåƒè§£æ**: å®Œæ•´çš„ Docker é•œåƒæ ¼å¼æ”¯æŒ
- **ğŸ—ï¸ é•œåƒé‡å»º**: æ™ºèƒ½é•œåƒé‡æ„ä¸åˆå¹¶å±‚
- **ğŸ¯ çµæ´»åˆå¹¶**: æ”¯æŒåŸºäºæ•°é‡å’Œ ID çš„å±‚åˆå¹¶
- **ğŸ”„ Docker åŠ è½½**: ä¸ Docker å®ˆæŠ¤è¿›ç¨‹ç›´æ¥é›†æˆ
- **ğŸ” å®Œæ•´æ€§æ£€æŸ¥**: SHA256 æ‘˜è¦è®¡ç®—å’ŒéªŒè¯
- **ğŸ“ å½’æ¡£å¤„ç†**: å®Œæ•´çš„ tar å½’æ¡£æ“ä½œ

## ğŸš€ æ€§èƒ½ç‰¹æ€§
- **ğŸ’¾ å†…å­˜é«˜æ•ˆ**: å¤§æ–‡ä»¶æµå¼å¤„ç†
- **ğŸ›¡ï¸ å®‰å…¨æ€§**: è·¯å¾„éå†ä¿æŠ¤å’Œè¾“å…¥éªŒè¯
- **ğŸ§¹ èµ„æºç®¡ç†**: ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†

## ğŸ”® è®¡åˆ’æ”¹è¿›
- **ğŸ“Š è¿›åº¦æŒ‡ç¤ºå™¨**: é•¿æ—¶é—´æ“ä½œçš„è¿›åº¦æ¡
- **ğŸ—œï¸ å‹ç¼©é€‰é¡¹**: å¯é…ç½®çš„å‹ç¼©ç®—æ³•


## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯• (13 ä¸ªæµ‹è¯•)
cargo test

# è¿è¡Œå¸¦è¯¦ç»†è¾“å‡ºçš„æµ‹è¯•
cargo test -- --nocapture

# è¿è¡Œç‰¹å®šæµ‹è¯•æ¨¡å—
cargo test docker::layer
```

### é›†æˆæµ‹è¯•
```bash
# è¿è¡Œé›†æˆæµ‹è¯•
cargo test --test integration_test

# è¿è¡Œä¾èµ– Docker çš„æµ‹è¯• (éœ€è¦ Docker)
cargo test --test integration_test -- --ignored

# è¿è¡ŒåŒ…æ‹¬è¢«å¿½ç•¥æµ‹è¯•åœ¨å†…çš„æ‰€æœ‰æµ‹è¯•
cargo test --test integration_test -- --include-ignored
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
cargo bench

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
cargo bench layer_merger_creation
```

### ğŸ”§ å¼€å‘æµ‹è¯•

#### æµ‹è¯•é•œåƒç”Ÿæˆ
```bash
# ç”Ÿæˆæµ‹è¯• Docker é•œåƒ
python3 create_test_image.py

# æµ‹è¯•åŸºæœ¬å‹ç¼©åŠŸèƒ½
cargo run -- squash --source test-docker-image.tar --output squashed.tar --layers 2 --verbose

# æµ‹è¯•åŸºäºå±‚ ID çš„åˆå¹¶
cargo run -- squash --source test-docker-image.tar --output squashed-by-id.tar --layers "abc12345" --verbose
```

#### ä»£ç è´¨é‡æ£€æŸ¥
```bash
# è¿è¡Œ clippy è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥
cargo clippy --all-targets --all-features

# æ ¼å¼åŒ–ä»£ç 
cargo fmt

# å®‰å…¨å®¡è®¡
cargo audit
```

### ğŸ“ è´¡çŒ®æŒ‡å—
1. Fork ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. è¿›è¡Œæ›´æ”¹å¹¶æ·»åŠ æµ‹è¯•
4. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
5. æäº¤ pull request


## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**é”™è¯¯: "Layer ID must be at least 8 characters long"**
- è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨å±‚ ID åŒ¹é…æ—¶æä¾›è‡³å°‘ 8 ä¸ªå­—ç¬¦
- ç¤ºä¾‹: ä½¿ç”¨ `--layers "abc12345"` è€Œä¸æ˜¯ `--layers "abc"`

**é”™è¯¯: "Cannot merge 0 layers"**
- è§£å†³æ–¹æ¡ˆ: æŒ‡å®šæœ‰æ•ˆçš„å±‚æ•°è¿›è¡Œåˆå¹¶ (1 æˆ–æ›´å¤š)
- ç¤ºä¾‹: ä½¿ç”¨ `--layers 2` è€Œä¸æ˜¯ `--layers 0`

**å¤§é•œåƒå†…å­˜é—®é¢˜**
- è§£å†³æ–¹æ¡ˆ: åœ¨æœ‰è¶³å¤Ÿç©ºé—´çš„ç£ç›˜ä¸Šä½¿ç”¨è‡ªå®šä¹‰ä¸´æ—¶ç›®å½•
- ç¤ºä¾‹: `--temp-dir /path/to/large/disk/temp`

**Docker å®ˆæŠ¤è¿›ç¨‹è¿æ¥é—®é¢˜**
- è§£å†³æ–¹æ¡ˆ: ç¡®ä¿ Docker æ­£åœ¨è¿è¡Œä¸”å¯è®¿é—®
- æ£€æŸ¥: `docker info` åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†è¾“å‡ºè¿›è¡Œè°ƒè¯•
squash squash --source image:tag --output result.tar --layers 2 --verbose

# æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†çš„å¤„ç†ä¿¡æ¯
RUST_LOG=debug cargo run -- squash --source image:tag --output result.tar --layers 2
```


**ç”¨ â¤ï¸ å’Œ Rust åˆ¶ä½œ** | **å¦‚æœè§‰å¾—æœ‰ç”¨è¯·ç»™ä¸ª â­ Starï¼**


## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦æƒ…è¯·å‚é˜… [LICENSE](LICENSE) æ–‡ä»¶ã€‚
